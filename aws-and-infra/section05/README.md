# [section05]【Route53】ドメインを登録しよう

Route53 で取得したドメインで web サイトにアクセスできるようにする

## ドメインについて

- ドメイン名の構造  
   www[第 4 レベルドメイン].example[第 3 レベルドメイン].co[第 2 レベルドメイン].jp[トップレベルドメイン]
- ドメインの管理
  - ICANN  
     ドメイン全体を管理
  - レジストリ  
     トップレベルドメインを管理  
     レジストラに卸す  
     .jp => JPRS / .com .ne => Verisign が管理している
  - レジストラ（ドメインの登録事業者）  
     リセラに卸す  
     一般消費者に販売  
     お名前.com やゴンベエドメインが販売
  - リセラ（再販事業者）
    一般消費者に販売  
     Yahoo!ドメインやムームードメイン、VALUE-DOMAIN が販売

## DNS について

取得したドメインとサーバー（IP アドレス）を紐付ける役割

- DNS（Domain Name System）とは  
   ドメイン名のドメイン管理システム  
   ドメイン名を IP アドレスに変換する  
   ネームサーバーとフルリゾルバの２つから構成される
  - ネームサーバー  
     ドメイン名とそれに紐づく IP アドレスが登録されているサーバー  
     ドメインの階層ごとにネームサーバーが配置され、そのネームサーバーが配置された階層のドメインに関する情報を管理する
  - フルリゾルバ  
     指定したドメイン名と IP アドレスが紐づくものを各ネームサーバーから調べて教えてくれる
  - DNS が管理するもの  
     様々な情報を管理しておりそれぞれをリソースコードと呼ぶ
    - A レコード：ドメインに紐づく IP アドレス
    - NS レコード：ドメインのゾーンを管理するネームサーバー
    - MX レコード：ドメインに紐づくメール受信サーバー
    - CNAME：ドメインの別名でリソースレコードの参照先
    - SOA：ドメインのゾーン管理情報

## Route53 とは

AWS の DNS サービスでネームサーバーの役割を担う

- 特徴
  - 高可用性、SLA（稼働率）100%
  - 高速（エッジロケーションの中で最も近いロケーションから応答を返す）
  - フルマネージドサービス（DNS サーバーの設計・構築・維持管理が不要）
- 重要概念
  - ホストゾーン：DNS のリソースレコードの集合（ゾーンファイルのようなもの）
  - レコードセット：リソースレコードのこと
  - ルーティングポリシー：Route53 が Record Set に対してどのようにルーティングを行うか決める
  - ヘルスチェック：サーバーの稼働状況をチェック
- ルーティングポリシーについて
  - シンプル[今回設定する]  
     レコードセットで事前に設定された値に基づいてドメインへの問い合わせに応答する
  - 加重  
     複数エンドポイント毎に設定された重みづけに基づいて、ドメインへの問い合わせに応答する  
     提供リソースに差がある場合や、AB テスト時に使用
  - レイテンシー  
     リージョン間の遅延が少ない方へリソースへルーティングする  
     マルチリージョンにリソースが存在する場合に使用
  - 位置情報  
     クライアントの位置情報に基づいてドメインへの問い合わせに応答する  
     コンテンツのローカライズや地域限定配信時に使用
  - フェイルオーバー  
     ヘルスチェックの結果に基づいて利用可能なリソースへルーティングをする  
     障害発生時に Sorry サーバーへ簡単に切り替えられる

## Route53 で DNS を設定

- 作業手順

  - ホストゾーンの作成  
    AWS マネジメントコンソール＞ Route53 ＞「DNS 管理」のホストゾーンの作成

    1.  ドメイン名にドメインを指定
    2.  タイプをパブリックホストゾーンを指定
    3.  「ホストゾーンの作成」を選択  
         ホストゾーン一覧に作成したホストゾーンが表示されていることを確認  
         （タイプが NS と SOA の 2 つが作成される）

  - 現在の状況確認  
     AWS マネジメントコンソール＞ EC2 ＞インスタンス  
     インスタンスの状態が[running]で ElasticIP が設定されていることを確認して、ElasticIP アドレスを控えておく  
     ※確認できない場合は[学習前の作業を参照](../README.md)  
     rlogin でサーバーにログインする  
     ※ElasticIP を再取得している場合は rlogin の接続情報を編集する必要がある
    以下コマンドを実行
    dig コマンドはドメイン名から IP アドレスを調べるコマンド（逆も可能）  
     `dig kaitobono.work NS +short`

  - ネームサーバーの変更  
     ドメイン取得元の管理画面からネームサーバーを Route53 へ変更する  
     （今回はお名前ドットコムでドメイン取得している）

    1. お名前ドットコムの管理画面からドメイン一覧を表示
    2. ネームサーバーの[初期設定]を選択
    3. ネームサーバーの選択の[その他]を開く
    4. Route53 のホストゾーンからタイプ NS のレコード欄にある値/トラフィックのルーティング先の情報をそれぞれ入力して[確認]を選択
    5. 設定内容を確認して[OK]を選択

  - ドメインに EC2 インスタンスの IP アドレスを紐付ける

    1. AWS マネジメントコンソール＞ Route53 ＞ホストゾーン＞ドメインを選択
    2. [レコードを作成]を選択
    3. ルーティングポリシー：シンプルルーティング
    4. [シンプルなレコードを定義]を選択
    5. 値/トラフィックのルーティング先：レコードタイプに応じた IP アドレスまたは別の道を選択してインスタンスの IP アドレスを入力
    6. レコードタイプ：A
    7. [シンプルなレコードを定義]を選択
    8. [レコードを作成]を選択  
       作成したレコードが一覧に表示されていることを確認

  - 作業の確認  
     以下コマンドを実施してネームサーバーが変更した内容になっていること  
     `dig kaitobono.work NS +short`  
     取得したドメインをブラウザに入力してページが表示されること  
     取得ドメイン「kaitobono.work」
