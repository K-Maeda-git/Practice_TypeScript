# [section03]【VPC】ネットワークを構築しよう

## AWS のネットワーク概念

- リージョン  
  AWS の各サービスが提供されている地域のこと  
  リージョンによって提供サービスが異なる
- アベイラビリティゾーン  
  独立したデータセンター群のこと  
  各リージョン複数の独立したデータセンターが存在する
- VPC  
  AWS 上に仮想ネットワークを作成することができるサービス  
  VPC はリージョンをまたいで作成することは出来ないが、アベイラビリティゾーンをまたいでの作成は可能
  - サブネット  
    VPC を細かく区切ったネットワーク空間  
    例）パブリックサブネット（web サーバー）やプライベートサブネット（DB サーバー）

リージョン＞アベイラビリティゾーン＞ VPC ＞サブネット

## ネットワークの IP アドレスを決める

- IP アドレスとは  
   ネットワーク上の機器を識別するためのインターネット上の住所
  - 特徴
    - ネットワーク上で重複しない番号
    - 32 ビットの整数値で構成
    - 読みにくいので IP アドレスを 8 ビットずつの 4 つの組に分け.（ピリオド）を入れて 10 進数で表現している
    - 0.0.0.0~255.255.255.255 まで
  - ビット、バイト、2 進数、10 進数
    - 2 進数  
       各行を 0 か 1 を使って数値を表す
    - ビット  
       2 進数の 1 桁（0 か 1）コンピュータのデータ最小単位
    - バイト  
       8 ビットを 1 バイトと呼ぶ。1 バイト＝ 8 ビット
    - 10 進数  
       １０種類の数値（0~9）を使い数値を表す。
  - パプリック IP アドレス
    - インターネットに接続する際に使用する IP アドレスのこと
    - ICANN という団体が重複しないよう管理を行う
    - プロバイダー、サーバー事業者から付与（貸し出し）される
  - プライベート IP アドレス
    - インターネットで使用されない IP アドレス
    - 範囲内のアドレスであれば自由に使用することができる
    - 社内 LAN などの構築やネットワーク実験時に用いる（インターネットに接続する必要がないとき）
  - IP アドレスの範囲を表記  
     ネットワーク構築する際には、そのネットワークで利用する IP アドレスの範囲を決める必要がある。  
     IP アドレスはネットワーク部とホスト部に区分けすることで、範囲を表記する。  
     例）192.168.128.0~192.168.128.255 の範囲を指定したとすると前半の固定部分（値が変わらない部分）のことをネットワーク部、後半の可変部分（値が変わる部分）のことをホスト部と呼ぶ。
  - IP アドレス範囲の表記法
    1. CIDR 表記  
       IP アドレスの後ろに「/」を書き、その後ろにネットワーク部が先頭から何ビット目までなのかを記載する。
    2. サブネットマスク表記  
       IP アドレスの後ろに「/」を書き、ネットワーク部を表すビットと同じ部分を１に、ホスト部を表すビットと同じ部分を０にする。

## VPC の作成

- 作成手順
  1. VPC 作成
     リージョンを「東京」に変更
     AWS マネジメントコンソール＞ VPC ＞ VPC ＞ VPC の作成
     名前タグ、IPv4 CIDR ブロック、IPv6 CIDR ブロック、テナンシーそれぞれ入力して「VPC の作成」を選択
     VPC の一覧に作成した VPC が表示されていることを確認
  2. サブネット作成
     - パブリックサブネットを作成
     - プライベートサブネットを作成
     - 操作手順
       AWS マネジメントコンソール＞ VPC ＞サブネット＞サブネットの作成  
       名前タグ、VPC、アベイラビリティゾーン、IPv4 CIDR ブロックそれぞれ入力して「作成」を選択  
       サブネットの一覧に作成したサブネットが表示されていることを確認
  3. ルーティングを設定する
     パブリックサブネットからインターネットに接続できるようにする
     - ルーティングとは  
       インターネットはルーターが IP アドレスの行き先を管理しているので、ネットワークとネットワークが IP アドレスを通じて接続することができる。  
       これをルーティングという。
     - ルートテーブルとは
       宛先の IP アドレスと次のルーター（ターゲット）という書式で設定  
       ルートテーブルに登録されているどのアドレスにも一致しない場合の経路のことを「デフォルトルート」と言う。  
        各サブネットに対してルートテーブルを設定することができる  
        サブネットやインターネットゲートウェイ間にはルーターが動いている
     - インターネットゲートウェイとは  
        VPC とインターネットを繋ぐ仮想ルーターのこと
     - インターネットゲートウェイを作成し、VPC にアタッチする       
       AWS マネジメントコンソール＞ VPC ＞インターネットゲートウェイ＞インターネットゲートウェイの作成  
       名前タグを入力して作成し、一覧に作成したインターネットゲートウェイが表示されていることを確認（状態が detached）  
       ＞作成したインターネットゲートウェイを選択＞アクション＞ VPC にアタッチを選択  
       VPC を選び、アタッチを選択する。作成したインターネットゲートウェイの状態が attached になっていることを確認
     - ルートテーブルを作成し、パブリックサブネットに紐付け  
        パプリックサブネットからインターネットに接続できるようになる
       - ルートテーブル作成
         AWS マネジメントコンソール＞ VPC ＞ ルートテーブル＞ルートテーブルの作成  
         名前タグを入力して、VPC を選択して作成し、一覧に作成したルートテーブルが表示されていることを確認
       - パプリックサブネットに紐付け  
         ルートテーブル一覧から先ほど作成したルートテーブルを選択＞画面下部の[サブネットの紐付け]タブを選択＞サブネットの関連付けの編集を選択  
         パプリックサブネットを選択して保存し、サブネットの関連付けタブを表示して関連付けが正常であることを確認する。
       - デフォルトルートをインターネットゲートウェイに設定  
         ルートテーブル一覧から先ほど作成したルートテーブルを選択＞画面下部の[ルート]タブを選択＞ルートの編集を選択  
         ルートの追加を選択して送信先(0.0.0.0/0)、ターゲット(Internet Gateway)を設定してルートの保存を選択して、一覧に戻りルートタブを確認して設定内容が正しいことを確認
     - ネットワーク設計で考慮すべきポイント
       1. VPC の設計ポイント
          - プライベート IP アドレスの範囲から指定する  
             VPC では仮想のプライベートネットワーク空間を作成するので、プライベート IP アドレスの仕様が推奨
          - 作成後は変更できないので大きめに設定する  
             大きさは/28 から/16（/16 推奨）
          - オンプレミスや他 VPC のレンジと重複しないように気をつける  
             相互接続する可能性がある場合重複しないよう設計すること
       2. VPC を分割するか、アカウントを分けるか
          - 異なるシステムの場合アカウントを分ける  
             異なるシステムを同一アカウント内に入れると管理が煩雑になるため
          - 同一システムの各環境は VPC とアカウントどちらで分けるべきか
            - 環境が違う場合アカウントも VPC も同一の使用は NG
            - VPC を分けると IAM の設定が一度で済む反面各環境のリソースが見えてしまい、事故の元となる
            - アカウントを分けると他の環境のリソースが見えず、作業しやすい反面環境ごとに IAM の設定が必要
            - 同一アカウントで VPC とリージョンを分けるのがおすすめ
     - サブネット設計のポイント     
        1. 将来必要なIPアドレス数を見積もって設定する       
            - /24が標準的       
        2. サブネットの分割はルーティングとアベイラビリティゾーンを基準に行う       
            - サブネットに割り当てられるルートテーブルは一つ        
            - インターネットアクセスの有無、拠点アクセスの有無などのルーティングポリシーに応じて分割する        
            - 高可用性のために2つ以上のアベイラビリティゾーンを使用する     
        