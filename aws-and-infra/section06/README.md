# [section06]【RDS】DB サーバーを構築しよう

プライベートサーバーに DB サーバーを設置する

## RDS とは

フルマネージドなリレーショナルデータベースのサービス  
 アプリケーションを DB に最適化するだけで利用可能

- 特徴  
   構築・運用の手間が少ない  
   以下の作業をする手間が不要  
   物理サーバー / OS インストール / アップデート / バックアップ / スケーリング
- メリット
  - 可用性の向上（マルチ AZ を簡単構築）
  - パフォーマンスの向上（リードレプリカを簡単構築）
  - 運用負荷軽減（自動バックアップ・自動ソフトウェアメンテナンス・監視）
- 概要
  - 利用可能エンジン
    1.  MySQL
    2.  PostgreSQL
    3.  Oracle
    4.  Microsoft SQL Server
    5.  Amazon Aurora
    6.  MariaDB
  - 各種設定パラメータ（DB の設定を変更する項目）
    1.  DB パラメータグループ：DB 設定値を変更
    2.  DB オプショングループ：RDS への機能追加を制御
    3.  DB サブネットグループ：RDS を起動させるサブネットを制御

## プライベートサブネット作成

- 操作手順

  - サブネットの作成  
     AWS マネジメントコンソール＞ VPC ＞サブネット＞サブネットの作成  
     名前タグ / VPC / アベイラビリティゾーン / IPv4 CIDR ブロック  
     それぞれ設定して「作成」を選択  
     サブネット一覧に作成したサブネットが作成されていることを確認

## RDS の作成準備

- セキュリティグループの作成（EC2）  
   web サーバーからのみ MySQL で DB に接続できるようにする

- 手順  
   AWS マネジメントコンソール＞ EC2 ＞セキュリティグループ＞セキュリティグループの作成  
   セキュリティグループ名 / 説明 を入力して「ルールの追加」を選択  
   タイプ：MYSQL/Aurora  
   プロトコル：TCP（既定値）  
   ポート範囲：3306（既定値）  
   ソース：カスタム（セキュリティグループのグループ ID を入力）  
   セキュリティグループ一覧に表示されていることを確認

- DB サブネットグループの作成

  - 手順  
     AWS マネジメントコンソール ＞ RDS ＞ サブネットグループ ＞ DB サブネットグループの作成

    - サブネットグループの詳細  
       名前 / 説明 / VPC をそれぞれ設定
    - サブネットを追加  
       アベイラビリティゾーン / サブネット をそれぞれ追加する  
       「作成」を選択して一覧に表示されることを確認

- DB パラメータグループの作成

  - 手順  
     AWS マネジメントコンソール ＞ RDS ＞ パラメータグループ ＞ パラメータグループの作成

    - パラメータグループの詳細  
       パラメータグループファミリー：mysql8.0  
       グループ名 / 説明 を入力して「作成」を選択  
       一覧に表示されることを確認  
       パラメータを変更したい場合は該当のパラメータグループを選択＞パラメータグループアクション＞編集  
       変更可能欄が[true]であれば変更が可能  
       適用タイプが  
       [static]=>RDS インスタンスの起動後に変更を反映  
       [dynamic]=>RDS インスタンスに動的に変更を反映

- DB オプショングループの作成
  - 手順  
     AWS マネジメントコンソール ＞ RDS ＞ オプショングループ ＞ グループを作成
    - オプショングループの詳細  
       名前 / 説明 を入力  
       エンジン：mysql  
       メジャーエンジンバージョン：8.0  
       「作成」を選択して一覧に表示されることを確認  
       ※グループを作成するとデフォルトのグループも一緒に作成される

## RDS の作成

- 手順  
  AWS マネジメントコンソール ＞ RDS ＞ データベース データベースの作成
  - データベース作成方法を選択  
    標準作成
  - エンジンのオプション  
     エンジンのタイプ：MySQL  
     バージョン：MySQL 8.0.15(※教材に合わせている)
  - テンプレート  
     開発/テスト
  - 設定  
     DB インスタンス識別子 / マスターユーザー名 / マスターパスワード をそれぞれ設定
  - DB インスタンスサイズ  
     バースト可能クラス[db.t2.micro]
  - ストレージ  
     ストレージタイプ：汎用（SSD）  
     ストレージ割り当て：20GiB  
     ストレージの自動スケーリング：無効
  - 可用性と耐久性  
     「スタンバイインスタンスを作成しないでください」を選択
  - 接続  
     作成した VPC を選択
    - 追加の接続設定  
       サブネットグループ：自身で作成したもの  
       パブリックアクセス可能：なし  
       VPC セキュリティグループ：自身で作成したもの  
       アベイラビリティゾーン / データベースポート：それぞれ設定  
       （ここでは ap-northeast-1a / 3306）
  - データベース認証
  - 追加設定  
     最初のデータベース名：無記入  
     DB パラメータグループ：自身で作成したパラメータグループを指定  
     オプショングループ：自身で作成したパラメータグループを指定  
     その他任意に設定する     
   「データベースの作成」を選択して一覧に表示されていることを確認    
   情報の欄が作成中→利用可能になれば完了      

## webサーバーからRDSに接続      
- WebサーバーにMySQLをインストール     
   - webサーバーにmySQLをインストール     
      以下コマンドをrloginで実施    
      `sudo yum -y install mysql`
- WebサーバーからRDSへmysqlコマンドで接続    
      AWSマネジメントコンソール＞RDS＞データベース＞DBを選択      
      接続とセキュリティにあるエンドポイントを控える     
      下記コマンドを実施      
      `mysql -h [控えたエンドポイント] -u [マスターユーザー名] -p`      
      パスワードを求められるので入力      
      Welcomeメッセージが表示されれば完了    

